<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<div th:fragment="dashboard">

    <h2 class="mb-4 text-primary">
        <i class="bi bi-speedometer2"></i> Dashboard General
    </h2>

        <!-- TARJETAS -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="stat-card">
                <i class="bi bi-people text-primary"></i>
                <h3 th:text="${totalClientes}"></h3>
                <p class="text-muted">Total Clientes</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <i class="bi bi-check-circle text-success"></i>
                <h3 th:text="${clientesActivos}"></h3>
                <p class="text-muted">Clientes Activos</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <i class="bi bi-star text-warning"></i>
                <h3 th:text="${clientesEnFidelizacion}"></h3>
                <p class="text-muted">En Fidelización</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <i class="bi bi-exclamation-triangle text-danger"></i>
                <h3 th:text="${clientesMorosos}"></h3>
                <p class="text-muted">Morosos</p>
            </div>
        </div>
    </div>

    <!-- SEGMENTACION -->
    <div class="card shadow-sm mb-4 p-4">
        <h5 class="fw-bold">Segmentación de Clientes por Tipo</h5>

        <div class="col-lg-7 mx-auto">
            <canvas id="chartSegmentacion" height="500"></canvas>
        </div>

        <p class="text-center text-muted mt-3">
            <span th:text="'(Natural: ' + ${porcentajeNaturales} + '% , Jurídico: ' + ${porcentajeJuridicos} + '% , Constructor: ' + ${porcentajeConstructor} + '% , Corporativo: ' + ${porcentajeCorporativos} + '%)'"></span>
        </p>
    </div>

    <!-- TABLA -->
    <div class="card shadow-sm p-3">
        <div class="d-flex justify-content-between">
            <h5 class="fw-bold">Clientes Fidelizados</h5>
            <a href="/fidelizacion" class="btn btn-primary btn-sm">Gestionar Fidelizacion</a>
        </div>

        <table class="table table-striped mt-3">
            <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Tipo</th>
                <th>Fecha Registro</th>
                <th>Estado</th>
                <th>Nivel Fidelización</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>100259</td>
                <td>Juan Pérez Rodríguez</td>
                <td>Natural</td>
                <td>15/08/2025</td>
                <td><span class="badge bg-success">Activo</span></td>
                <td><span class="badge bg-warning text-dark">Oro</span></td>
            </tr>
            <tr>
                <td>100258</td>
                <td>Constructora Andina S.A.C.</td>
                <td>Jurídico</td>
                <td>14/08/2025</td>
                <td><span class="badge bg-success">Activo</span></td>
                <td><span class="badge bg-secondary">Plata</span></td>
            </tr>
            </tbody>
        </table>

    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {

        const canvas = document.getElementById('chartSegmentacion');
        if (!canvas) return;

        // Destruir gráfico anterior si existe
        if (Chart.getChart("chartSegmentacion")) {
            Chart.getChart("chartSegmentacion").destroy();
        }

        // Obtener los datos del backend (pasados por Thymeleaf)
        let clientesNaturales = [[${porcentajeNaturales}]];
        let clientesJuridicos = [[${porcentajeJuridicos}]];
        let clientesConstructor = [[${porcentajeConstructor}]];
        let clientesCorporativos = [[${porcentajeCorporativos}]];

        // Calcular la suma total de porcentajes
        let total = clientesNaturales + clientesJuridicos + clientesConstructor + clientesCorporativos;

        // Normalizar los valores si no suman 100%
        clientesNaturales = (clientesNaturales / total) * 100;
        clientesJuridicos = (clientesJuridicos / total) * 100;
        clientesConstructor = (clientesConstructor / total) * 100;
        clientesCorporativos = (clientesCorporativos / total) * 100;

        clientesNaturales = clientesNaturales.toFixed(2);
        clientesJuridicos = clientesJuridicos.toFixed(2);
        clientesConstructor = clientesConstructor.toFixed(2);
        clientesCorporativos = clientesCorporativos.toFixed(2);

        new Chart(canvas, {
            type: 'doughnut',
            data: {
                labels: ['Natural', 'Jurídico', 'Constructor', 'Corporativo'],
                datasets: [{
                    data: [
                        clientesNaturales,
                        clientesJuridicos,
                        clientesConstructor,
                        clientesCorporativos
                    ],
                    backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545'],
                    borderColor: '#fff',
                    borderWidth: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                return tooltipItem.raw.toFixed(2) + '%';
                            }
                        }
                    }
                }
            }
        });
    });
</script>
</html>