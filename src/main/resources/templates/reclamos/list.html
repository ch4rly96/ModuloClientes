<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Listado de Reclamos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="p-4">

<h2 class="mb-3">Listado de Reclamos</h2>

<a href="/reclamos/nuevo" class="btn btn-primary mb-3">Nuevo Reclamo</a>

<table class="table table-striped table-bordered">
    <thead class="table-dark">
    <tr>
        <th>ID</th>
        <th>Número Reclamo</th>
        <th>Cliente</th>
        <th>Motivo</th>
        <th>Estado</th>
        <th>Fecha</th>
        <th>Opciones</th>
    </tr>
    </thead>
    <tbody id="reclamosTabla">
    <!-- Los datos se cargarán por JavaScript -->
    </tbody>
</table>

<script>
    // Cargar reclamos al iniciar la página
    fetch('/api/reclamos')
        .then(response => {
            if (!response.ok) throw new Error('Error al cargar reclamos');
            return response.json();
        })
        .then(reclamos => {
            const tabla = document.getElementById('reclamosTabla');
            tabla.innerHTML = '';

            reclamos.forEach(reclamo => {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                <td>${reclamo.idReclamo || reclamo.id}</td>
                <td>${reclamo.numeroReclamo || 'N/A'}</td>
                <td>${getNombreCliente(reclamo.cliente)}</td>
                <td>${reclamo.motivo || 'Sin motivo'}</td>
                <td>
                    <span class="badge ${getBadgeClass(reclamo.estado)}">${reclamo.estado}</span>
                </td>
                <td>${formatFecha(reclamo.fechaReclamo)}</td>
                <td>
                    <a class="btn btn-info btn-sm" href="/reclamos/${reclamo.idReclamo || reclamo.id}">Ver</a>
                    <a class="btn btn-warning btn-sm" href="/reclamos/${reclamo.idReclamo || reclamo.id}/editar">Editar</a>
                    <button class="btn btn-danger btn-sm" onclick="eliminarReclamo(${reclamo.idReclamo || reclamo.id})">Eliminar</button>
                </td>
            `;
                tabla.appendChild(fila);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('reclamosTabla').innerHTML =
                '<tr><td colspan="7" class="text-center text-danger">Error al cargar los reclamos</td></tr>';
        });

    function getNombreCliente(cliente) {
        if (!cliente) return 'N/A';
        if (cliente.nombres && cliente.apellidos) {
            return `${cliente.nombres} ${cliente.apellidos}`;
        }
        if (cliente.razonSocial) {
            return cliente.razonSocial;
        }
        return `Cliente ${cliente.idCliente || cliente.id}`;
    }

    function getBadgeClass(estado) {
        const estadoUpper = estado?.toUpperCase();
        switch(estadoUpper) {
            case 'PENDIENTE': return 'bg-warning';
            case 'EN_PROCESO':
            case 'EN_PROCESO': return 'bg-info';
            case 'RESUELTO': return 'bg-success';
            case 'CERRADO': return 'bg-secondary';
            default: return 'bg-secondary';
        }
    }

    function formatFecha(fechaString) {
        if (!fechaString) return 'N/A';
        try {
            return new Date(fechaString).toLocaleDateString('es-ES');
        } catch {
            return fechaString;
        }
    }

    function eliminarReclamo(id) {
        if (confirm('¿Está seguro de eliminar este reclamo?')) {
            fetch(`/reclamos/${id}/eliminar`, { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Error al eliminar el reclamo');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al eliminar el reclamo');
                });
        }
    }
</script>

</body>
</html>